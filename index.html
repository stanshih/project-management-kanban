<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專案管理看板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .task-dragging { opacity: 0.5; transform: rotate(3deg); }
        .column-dragover { background-color: #f0f9ff; border-color: #38bdf8; }
        .tasks-container::-webkit-scrollbar { display: none; }
        .tasks-container { -ms-overflow-style: none; scrollbar-width: none; }
        .task-description { white-space: pre-wrap; word-break: break-word; }
        .viewer-mode .task-card { cursor: default !important; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-spinner" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <svg class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
    </div>

    <div id="login-view" class="hidden">
        <div class="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
            <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8">
                <h1 class="text-3xl font-bold mb-2 text-center text-gray-700">專案管理看板</h1>
                <p class="text-gray-500 mb-6 text-center">請使用管理員提供的帳號登入</p>
                <form id="auth-form" onsubmit="return false;"><div class="mb-4"><label for="email" class="block text-gray-700 font-medium mb-2">電子郵件</label><input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div><div class="mb-6"><label for="password" class="block text-gray-700 font-medium mb-2">密碼</label><input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div><div id="auth-error" class="mb-4 text-center text-red-500 text-sm h-5"></div><div class="flex"><button type="button" id="login-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition">登入</button></div></form>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden container mx-auto p-4 md:p-8">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-indigo-500 rounded-lg flex items-center justify-center shrink-0"><i data-lucide="layout-dashboard" class="w-6 h-6 text-white"></i></div>
                <select id="boardSelector" class="text-2xl font-bold text-gray-700 bg-transparent border-none focus:ring-0 appearance-none"></select>
            </div>
            <div class="flex items-center space-x-2 sm:space-x-4 flex-wrap justify-center">
                <button id="manageMembersBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition hidden">管理成員</button>
                <button id="shareBoardBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition hidden">分享</button>
                <button id="addTaskBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition">新增任務</button>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition">登出</button>
            </div>
        </header>
        <main id="board" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white rounded-xl shadow-lg flex flex-col h-full" data-status="todo"><h2 class="text-lg font-bold p-4 border-b-4 border-red-400 flex items-center space-x-2"><i data-lucide="list" class="w-5 h-5 text-red-500"></i><span>待辦事項</span></h2><div id="todo-tasks" class="tasks-container p-4 space-y-4 overflow-y-auto flex-grow min-h-[200px] transition-colors duration-300"></div></div>
            <div class="bg-white rounded-xl shadow-lg flex flex-col h-full" data-status="inprogress"><h2 class="text-lg font-bold p-4 border-b-4 border-yellow-400 flex items-center space-x-2"><i data-lucide="loader-circle" class="w-5 h-5 text-yellow-500 animate-spin" style="animation-duration: 3s;"></i><span>進行中</span></h2><div id="inprogress-tasks" class="tasks-container p-4 space-y-4 overflow-y-auto flex-grow min-h-[200px] transition-colors duration-300"></div></div>
            <div class="bg-white rounded-xl shadow-lg flex flex-col h-full" data-status="done"><h2 class="text-lg font-bold p-4 border-b-4 border-green-400 flex items-center space-x-2"><i data-lucide="check-circle-2" class="w-5 h-5 text-green-500"></i><span>已完成</span></h2><div id="done-tasks" class="tasks-container p-4 space-y-4 overflow-y-auto flex-grow min-h-[200px] transition-colors duration-300"></div></div>
        </main>
        <footer class="text-center mt-8 text-gray-500 text-sm"><p>使用者: <span id="userEmail" class="font-mono bg-gray-200 px-2 py-1 rounded">載入中...</span> <span id="userRole" class="ml-2 font-semibold"></span></p></footer>
    </div>
    
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-20"><div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md" id="modal-content"><h3 id="modalTitle" class="text-2xl font-bold mb-6">新增任務</h3><form id="taskForm"><input type="hidden" id="taskId"><div class="mb-4"><label for="taskTitle" class="block text-gray-700 font-medium mb-2">任務標題</label><input type="text" id="taskTitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div><div class="mb-6"><label for="taskDescription" class="block text-gray-700 font-medium mb-2">任務描述</label><textarea id="taskDescription" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea></div><div class="flex justify-end space-x-4"><button type="button" id="cancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">取消</button><button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">儲存</button></div></form></div></div>
    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-20"><div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md"><h3 class="text-2xl font-bold mb-4">分享看板</h3><p class="text-gray-600 mb-4">複製連結並傳送給協作者：</p><input type="text" id="shareLinkInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly><div class="flex justify-end mt-4"><button id="closeShareModalBtn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">關閉</button></div></div></div>
    <div id="newBoardModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-20"><div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md"><h3 class="text-2xl font-bold mb-4">建立新的共享看板</h3><p class="text-gray-600 mb-4">請為您的新看板命名：</p><input type="text" id="newBoardName" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="例如：產品開發專案"><div class="flex justify-end mt-4 space-x-2"><button id="cancelNewBoardBtn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">取消</button><button id="confirmNewBoardBtn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg">建立</button></div></div></div>
    <div id="manageMembersModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-30">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg"><h3 class="text-2xl font-bold mb-4">管理成員</h3><div id="membersList" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div><div class="flex items-center space-x-2 pt-4 border-t"><input type="email" id="inviteEmail" class="w-full px-4 py-2 border rounded-lg" placeholder="輸入成員 Email..."><button id="inviteBtn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">邀請</button></div><p id="inviteError" class="text-red-500 text-sm h-4 mt-2"></p><div class="flex justify-end mt-4"><button id="closeMembersModalBtn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">關閉</button></div></div>
    </div>

    <template id="member-item-template"><div class="flex items-center justify-between p-2 bg-gray-50 rounded"><span class="text-gray-700"></span><div class="flex items-center space-x-2"><select class="role-selector border-gray-300 rounded"></select><button class="remove-member-btn text-red-500 p-1">&times;</button></div></div></template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, serverTimestamp, runTransaction, arrayUnion, arrayRemove, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyD648jO8xViAhhsDmUynDe6tY7IypYwzAU", authDomain: "my-project-kanban-fae66.firebaseapp.com", projectId: "my-project-kanban-fae66", storageBucket: "my-project-kanban-fae66.firebasestorage.app", messagingSenderId: "753453126057", appId: "1:753453126057:web:70e63a3d12571e48e734b8" };
        
        let db, auth, userId, userEmail;
        let tasksUnsubscribe = null, boardUnsubscribe = null;
        let currentBoard = { type: 'private', id: null, role: 'owner' };
        
        const views = { loading: document.getElementById('loading-spinner'), login: document.getElementById('login-view'), app: document.getElementById('app-container') };
        const modals = { task: document.getElementById('taskModal'), share: document.getElementById('shareModal'), newBoard: document.getElementById('newBoardModal'), members: document.getElementById('manageMembersModal') };
        
        function showView(viewId) { Object.values(views).forEach(v => v.classList.add('hidden')); if(views[viewId]) views[viewId].classList.remove('hidden'); }
        function cleanupListeners() { if(tasksUnsubscribe) tasksUnsubscribe(); if(boardUnsubscribe) boardUnsubscribe(); }

        async function startApp() {
            try { const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); lucide.createIcons(); } catch (e) { console.error("Firebase a 初始化失敗:", e); return; }
            onAuthStateChanged(auth, async (user) => {
                cleanupListeners();
                if (user) {
                    userId = user.uid; userEmail = user.email;
                    document.getElementById('userEmail').textContent = userEmail;
                    const userPublicRef = doc(db, "users_public_data", userId);
                    if (!(await getDoc(userPublicRef)).exists()) await setDoc(userPublicRef, { email: userEmail });
                    
                    const boardId = new URLSearchParams(window.location.search).get('boardId');
                    if (boardId) {
                        currentBoard.type = 'shared'; currentBoard.id = boardId;
                        const boardRef = doc(db, 'shared_boards', boardId);
                        const boardSnap = await getDoc(boardRef);
                        if (!boardSnap.exists()) { alert('看板不存在或已被刪除。'); window.location.href = window.location.pathname; return; }
                        let members = boardSnap.data().members || {};
                        if (!members[userId]) {
                           members[userId] = 'viewer';
                           await updateDoc(boardRef, { members });
                           await addBoardToUserListIfNeeded(boardId, boardSnap.data().name);
                        }
                        currentBoard.role = members[userId];
                    } else {
                        currentBoard = { type: 'private', id: userId, role: 'owner' };
                    }
                    showView('app');
                    await populateBoardSelector();
                    setupBoardListener();
                    setupTaskListener();
                } else {
                    showView('login');
                }
                showView(user ? 'app' : 'login');
                views.loading.classList.add('hidden');
            });
            setupGlobalEventListeners();
        }

        function setupGlobalEventListeners() {
            document.getElementById('login-btn').addEventListener('click', async () => { /* ... */ });
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('addTaskBtn').addEventListener('click', () => openModal('task'));
            document.getElementById('cancelBtn').addEventListener('click', () => closeModal('task'));
            document.getElementById('cancelNewBoardBtn').addEventListener('click', () => closeModal('newBoard'));
            document.getElementById('closeShareModalBtn').addEventListener('click', () => closeModal('share'));
            document.getElementById('closeMembersModalBtn').addEventListener('click', () => closeModal('members'));
            document.getElementById('manageMembersBtn').addEventListener('click', async () => { const boardSnap = await getDoc(doc(db, 'shared_boards', currentBoard.id)); if(boardSnap.exists()) { renderMembersList(boardSnap.data()); openModal('members'); }});
            document.getElementById('inviteBtn').addEventListener('click', handleInviteMember);
            document.getElementById('boardSelector').addEventListener('change', handleBoardSelection);
            document.getElementById('confirmNewBoardBtn').addEventListener('click', handleCreateNewBoard);
            document.getElementById('taskForm').addEventListener('submit', handleTaskFormSubmit);
            document.querySelectorAll('.tasks-container').forEach(c => { c.addEventListener('dragover', (e) => e.preventDefault()); c.addEventListener('drop', handleDrop); });
        }

        function setupBoardListener() {
            if (boardUnsubscribe) boardUnsubscribe();
            if (currentBoard.type === 'private') { updateUIForPermissions(); return; }
            const boardRef = doc(db, 'shared_boards', currentBoard.id);
            boardUnsubscribe = onSnapshot(boardRef, (docSnap) => {
                if (docSnap.exists()) {
                    const boardData = docSnap.data(), members = boardData.members || {}, userRole = members[userId];
                    if (!userRole) { alert('您已被移出此看板。'); window.location.href = window.location.pathname; return; }
                    currentBoard.role = userRole;
                    updateUIForPermissions();
                    if (!modals.members.classList.contains('hidden')) renderMembersList(boardData);
                } else {
                    alert('此共享看板已被刪除。'); window.location.href = window.location.pathname;
                }
            });
        }
        
        function updateUIForPermissions() {
            const role = currentBoard.role, isViewer = role === 'viewer', isOwner = role === 'owner';
            const canEdit = isOwner || role === 'editor';
            document.getElementById('addTaskBtn').style.display = canEdit ? 'flex' : 'none';
            document.getElementById('manageMembersBtn').style.display = (currentBoard.type === 'shared' && isOwner) ? 'flex' : 'none';
            document.getElementById('shareBoardBtn').style.display = currentBoard.type === 'shared' ? 'flex' : 'none';
            document.getElementById('board').classList.toggle('viewer-mode', isViewer);
            document.getElementById('userRole').textContent = currentBoard.type === 'shared' ? `(${role})` : '(個人)';
        }
        
        async function populateBoardSelector() {
            const selector = document.getElementById('boardSelector');
            selector.innerHTML = '';
            selector.add(new Option('我的私人看板', 'private'));
            const snapshot = await getDocs(collection(db, `users/${userId}/accessible_boards`));
            snapshot.forEach(doc => selector.add(new Option(doc.data().name, doc.id)));
            selector.add(new Option('+ 建立新的共享看板', 'create_new'));
            selector.value = currentBoard.type === 'private' ? 'private' : currentBoard.id;
        }
        
        async function addBoardToUserListIfNeeded(boardId, boardName, targetUserId = userId) {
            const boardRef = doc(db, `users/${targetUserId}/accessible_boards`, boardId);
            if (!(await getDoc(boardRef)).exists()) await setDoc(boardRef, { name: boardName });
        }
        
        function setupTaskListener() {
            if (tasksUnsubscribe) tasksUnsubscribe();
            const q = query(collection(db, getTasksCollectionPath()));
            tasksUnsubscribe = onSnapshot(q, (snapshot) => {
                document.querySelectorAll('.tasks-container').forEach(col => col.innerHTML = '');
                snapshot.docs.forEach(doc => {
                    const taskElement = renderTask({ id: doc.id, ...doc.data() });
                    const container = document.getElementById(`${taskElement.taskData.status}-tasks`);
                    if (container) container.appendChild(taskElement.card);
                });
                lucide.createIcons();
            });
        }
        
        function renderTask(task) {
            const card = document.createElement('div'); card.id = task.id;
            const isViewer = currentBoard.role === 'viewer';
            card.draggable = !isViewer;
            card.className = 'task-card bg-white p-4 rounded-lg border border-gray-200 shadow-sm transition-shadow hover:shadow-md ' + (isViewer ? 'cursor-default' : 'cursor-grab active:cursor-grabbing');
            card.innerHTML = `<div class="flex justify-between items-start"><h4 class="font-bold text-gray-800">${task.title}</h4><button class="delete-task-btn text-gray-400 hover:text-red-500" style="display: ${isViewer ? 'none' : 'block'}"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div><p class="text-sm text-gray-600 mt-2 task-description">${task.description || ''}</p>`;
            card.querySelector('.delete-task-btn').addEventListener('click', async (e) => { e.stopPropagation(); if(confirm('確定刪除此任務?')) await deleteDoc(doc(db, getTasksCollectionPath(), task.id)); });
            card.addEventListener('click', () => !isViewer && openModal('task', task));
            card.addEventListener('dragstart', (e) => { if(!isViewer) e.dataTransfer.setData('text/plain', e.target.id); });
            return { card: card, taskData: task };
        }

        function openModal(modalId, data = null) {
            const modal = modals[modalId];
            if (modalId === 'task') {
                const form = document.getElementById('taskForm'); form.reset();
                if (data) {
                    document.getElementById('modalTitle').textContent = '編輯任務';
                    document.getElementById('taskId').value = data.id;
                    document.getElementById('taskTitle').value = data.title;
                    document.getElementById('taskDescription').value = data.description;
                } else {
                    document.getElementById('modalTitle').textContent = '新增任務';
                }
            }
            modal.classList.remove('hidden');
        }

        function closeModal(modalId) { modals[modalId].classList.add('hidden'); }
        
        async function renderMembersList(boardData) {
            const listDiv = document.getElementById('membersList');
            listDiv.innerHTML = '';
            const members = boardData.members || {};
            for (const memberId in members) {
                const publicDoc = await getDoc(doc(db, "users_public_data", memberId));
                if (!publicDoc.exists()) continue;
                const memberEmail = publicDoc.data().email;
                const template = document.getElementById('member-item-template').content.cloneNode(true);
                const item = template.querySelector('div');
                item.querySelector('span').textContent = `${memberEmail} ${memberId === userId ? '(您)' : ''}`;
                const selector = item.querySelector('select'), removeBtn = item.querySelector('button');
                if (memberId === boardData.ownerId) { selector.outerHTML = `<span class="font-semibold text-gray-500">擁有者</span>`; removeBtn.remove(); } 
                else { ['editor', 'viewer'].forEach(role => selector.add(new Option(role.charAt(0).toUpperCase() + role.slice(1), role))); selector.value = members[memberId]; selector.dataset.id = memberId; removeBtn.dataset.id = memberId; }
                listDiv.appendChild(item);
            }
        }
        
        // Event Handler Implementations
        document.getElementById('login-btn').addEventListener('click', async () => { const e = document.getElementById('email').value, p = document.getElementById('password').value, errDiv = document.getElementById('auth-error'); errDiv.textContent = ''; try { await signInWithEmailAndPassword(auth, e, p); } catch (error) { errDiv.textContent = '登入失敗，請檢查信箱或密碼。'; }});
        async function handleInviteMember() {
            const emailToInvite = document.getElementById('inviteEmail').value.trim();
            const errorDiv = document.getElementById('inviteError'); errorDiv.textContent = ''; if (!emailToInvite) return;
            const q = query(collection(db, "users_public_data"), where("email", "==", emailToInvite));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) { errorDiv.textContent = '找不到該 Email 的使用者。'; return; }
            const invitedUserId = querySnapshot.docs[0].id;
            const boardRef = doc(db, 'shared_boards', currentBoard.id);
            const boardSnap = await getDoc(boardRef);
            if (boardSnap.data().memberIds.includes(invitedUserId)) { errorDiv.textContent = '該使用者已經是成員了。'; return; }
            await updateDoc(boardRef, { [`members.${invitedUserId}`]: 'viewer', memberIds: arrayUnion(invitedUserId) });
            await addBoardToUserListIfNeeded(currentBoard.id, boardSnap.data().name, invitedUserId);
            document.getElementById('inviteEmail').value = '';
        }
        function handleBoardSelection() { const val = document.getElementById('boardSelector').value; if (val === 'create_new') { openModal('newBoard'); document.getElementById('boardSelector').value = currentBoard.type === 'private' ? 'private' : currentBoard.id; } else if (val === 'private') { window.location.href = window.location.pathname; } else { window.location.href = `${window.location.pathname}?boardId=${val}`; } }
        async function handleCreateNewBoard() { const newBoardName = document.getElementById('newBoardName').value.trim(); if (!newBoardName) return alert('請輸入看板名稱'); const newBoardRef = doc(collection(db, 'shared_boards')); await setDoc(newBoardRef, { name: newBoardName, ownerId: userId, members: { [userId]: 'owner' }, memberIds: [userId], createdAt: serverTimestamp() }); await addBoardToUserListIfNeeded(newBoardRef.id, newBoardName); window.location.href = `${window.location.pathname}?boardId=${newBoardRef.id}`; }
        async function handleTaskFormSubmit(e) { e.preventDefault(); const id = document.getElementById('taskId').value, title = document.getElementById('taskTitle').value.trim(), description = document.getElementById('taskDescription').value.trim(); if (!title) return; const path = getTasksCollectionPath(), taskData = { title, description, updatedAt: serverTimestamp() }; if (id) await updateDoc(doc(db, path, id), taskData); else await addDoc(collection(db, path), { ...taskData, status: 'todo', createdAt: serverTimestamp() }); closeModal('task'); }
        async function handleDrop(e) { e.preventDefault(); if (currentBoard.role === 'viewer') return; const taskId = e.dataTransfer.getData('text/plain'), newStatus = e.currentTarget.parentElement.dataset.status; await updateDoc(doc(db, getTasksCollectionPath(), taskId), { status: newStatus }); }
        
        document.getElementById('membersList').addEventListener('change', async (e) => { if(e.target.classList.contains('role-selector')) { await updateDoc(doc(db, 'shared_boards', currentBoard.id), { [`members.${e.target.dataset.id}`]: e.target.value }); } });
        document.getElementById('membersList').addEventListener('click', async (e) => { const btn = e.target.closest('.remove-member-btn'); if(btn) { const idToRemove = btn.dataset.id; if(confirm('確定要移除這位成員嗎？')) { const boardRef = doc(db, 'shared_boards', currentBoard.id); await updateDoc(boardRef, { [`members.${idToRemove}`]: deleteField(), memberIds: arrayRemove(idToRemove) }); await deleteDoc(doc(db, `users/${idToRemove}/accessible_boards`, currentBoard.id)); } } });

        startApp();
    </script>
</body>
</html>
